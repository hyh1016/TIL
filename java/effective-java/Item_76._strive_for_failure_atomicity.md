# Item 76. 가능한 한 실패 원자적으로 만들라

## 메서드를 실패 원자적으로 만들라

- 실패 원자적이란, 메서드의 수행 내용이 전부 반영되거나 전부 반영되지 않아야 한다는 것
    - 트랜잭션의 원자성(Atomic)과 동일
- 메서드가 수행 중 실패하게 되면 객체가 비정상 상태가 되는 것이 아닌, `메서드 호출 이전 시점의 상태`로 복귀 (즉, 롤백)

### 메서드를 실패 원자적으로 만드는 방법

1. 객체를 불변으로 설계
    - 메서드의 동작이 기존 객체의 상태를 변경하는 것이 아닌, 새 객체를 생성해 반환
    - 객체의 상태는 생성 시점 이후로 절대 변화하지 않으므로 객체가 잘못된 상태를 가질 일이 없음
2. 메서드 수행에 앞서 매개변수의 유효성을 검사
    - 잠재적 예외를 미리 걸러내는 방식
3. 실패할 가능성이 있는 모든 코드를 객체 상태 변경 이전에 수행
    - 객체 상태를 변경하는 메서드의 수행 시점에 예외가 발생할 코드는 그 이전 시점에 미리 터지도록 하는 방식
4. 객체를 (임시 자료구조에) 복사하여 작업을 수행하고 문제가 없다면 원래 객체와 교환
5. 작업 도중 예외가 발생하면 이를 감지해 작업 전 상태로 되돌리는 `복구 코드` 작성

### 실패 원자성을 보장하지 못할 때

1. 멀티 스레드 환경에서 동시에 같은 객체를 수정하는 경우
2. Error가 발생한 경우(Item 70)
    - 어차피 복구가 불가능한 상황일 것이기 때문
3. 실패 원자성을 달성하기 위한 비용/복잡도가 매우 큰 경우

### 실패 원자성을 보장하지 못할 때에 대한 대처

- API 문서에 실패 시의 객체 상태를 명시
